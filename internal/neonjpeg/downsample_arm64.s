// See LICENSE for licensing information

#include "textflag.h"

DATA h2_downsample_consts<>+0x0(SB)/1, $0x00
DATA h2_downsample_consts<>+0x1(SB)/1, $0x01
DATA h2_downsample_consts<>+0x2(SB)/1, $0x02
DATA h2_downsample_consts<>+0x3(SB)/1, $0x03
DATA h2_downsample_consts<>+0x4(SB)/1, $0x04
DATA h2_downsample_consts<>+0x5(SB)/1, $0x05
DATA h2_downsample_consts<>+0x6(SB)/1, $0x06
DATA h2_downsample_consts<>+0x7(SB)/1, $0x07
DATA h2_downsample_consts<>+0x8(SB)/1, $0x08
DATA h2_downsample_consts<>+0x9(SB)/1, $0x09
DATA h2_downsample_consts<>+0xa(SB)/1, $0x0A
DATA h2_downsample_consts<>+0xb(SB)/1, $0x0B
DATA h2_downsample_consts<>+0xc(SB)/1, $0x0C
DATA h2_downsample_consts<>+0xd(SB)/1, $0x0D
DATA h2_downsample_consts<>+0xe(SB)/1, $0x0E
DATA h2_downsample_consts<>+0xf(SB)/1, $0x0F
DATA h2_downsample_consts<>+0x10(SB)/1, $0x00
DATA h2_downsample_consts<>+0x11(SB)/1, $0x01
DATA h2_downsample_consts<>+0x12(SB)/1, $0x02
DATA h2_downsample_consts<>+0x13(SB)/1, $0x03
DATA h2_downsample_consts<>+0x14(SB)/1, $0x04
DATA h2_downsample_consts<>+0x15(SB)/1, $0x05
DATA h2_downsample_consts<>+0x16(SB)/1, $0x06
DATA h2_downsample_consts<>+0x17(SB)/1, $0x07
DATA h2_downsample_consts<>+0x18(SB)/1, $0x08
DATA h2_downsample_consts<>+0x19(SB)/1, $0x09
DATA h2_downsample_consts<>+0x1a(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x1b(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x1c(SB)/1, $0x0C
DATA h2_downsample_consts<>+0x1d(SB)/1, $0x0D
DATA h2_downsample_consts<>+0x1e(SB)/1, $0x0E
DATA h2_downsample_consts<>+0x1f(SB)/1, $0x0E
DATA h2_downsample_consts<>+0x20(SB)/1, $0x00
DATA h2_downsample_consts<>+0x21(SB)/1, $0x01
DATA h2_downsample_consts<>+0x22(SB)/1, $0x02
DATA h2_downsample_consts<>+0x23(SB)/1, $0x03
DATA h2_downsample_consts<>+0x24(SB)/1, $0x04
DATA h2_downsample_consts<>+0x25(SB)/1, $0x05
DATA h2_downsample_consts<>+0x26(SB)/1, $0x06
DATA h2_downsample_consts<>+0x27(SB)/1, $0x07
DATA h2_downsample_consts<>+0x28(SB)/1, $0x08
DATA h2_downsample_consts<>+0x29(SB)/1, $0x09
DATA h2_downsample_consts<>+0x2a(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x2b(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x2c(SB)/1, $0x0C
DATA h2_downsample_consts<>+0x2d(SB)/1, $0x0D
DATA h2_downsample_consts<>+0x2e(SB)/1, $0x0D
DATA h2_downsample_consts<>+0x2f(SB)/1, $0x0D
DATA h2_downsample_consts<>+0x30(SB)/1, $0x00
DATA h2_downsample_consts<>+0x31(SB)/1, $0x01
DATA h2_downsample_consts<>+0x32(SB)/1, $0x02
DATA h2_downsample_consts<>+0x33(SB)/1, $0x03
DATA h2_downsample_consts<>+0x34(SB)/1, $0x04
DATA h2_downsample_consts<>+0x35(SB)/1, $0x05
DATA h2_downsample_consts<>+0x36(SB)/1, $0x06
DATA h2_downsample_consts<>+0x37(SB)/1, $0x07
DATA h2_downsample_consts<>+0x38(SB)/1, $0x08
DATA h2_downsample_consts<>+0x39(SB)/1, $0x09
DATA h2_downsample_consts<>+0x3a(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x3b(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x3c(SB)/1, $0x0C
DATA h2_downsample_consts<>+0x3d(SB)/1, $0x0C
DATA h2_downsample_consts<>+0x3e(SB)/1, $0x0C
DATA h2_downsample_consts<>+0x3f(SB)/1, $0x0C
DATA h2_downsample_consts<>+0x40(SB)/1, $0x00
DATA h2_downsample_consts<>+0x41(SB)/1, $0x01
DATA h2_downsample_consts<>+0x42(SB)/1, $0x02
DATA h2_downsample_consts<>+0x43(SB)/1, $0x03
DATA h2_downsample_consts<>+0x44(SB)/1, $0x04
DATA h2_downsample_consts<>+0x45(SB)/1, $0x05
DATA h2_downsample_consts<>+0x46(SB)/1, $0x06
DATA h2_downsample_consts<>+0x47(SB)/1, $0x07
DATA h2_downsample_consts<>+0x48(SB)/1, $0x08
DATA h2_downsample_consts<>+0x49(SB)/1, $0x09
DATA h2_downsample_consts<>+0x4a(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x4b(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x4c(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x4d(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x4e(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x4f(SB)/1, $0x0B
DATA h2_downsample_consts<>+0x50(SB)/1, $0x00
DATA h2_downsample_consts<>+0x51(SB)/1, $0x01
DATA h2_downsample_consts<>+0x52(SB)/1, $0x02
DATA h2_downsample_consts<>+0x53(SB)/1, $0x03
DATA h2_downsample_consts<>+0x54(SB)/1, $0x04
DATA h2_downsample_consts<>+0x55(SB)/1, $0x05
DATA h2_downsample_consts<>+0x56(SB)/1, $0x06
DATA h2_downsample_consts<>+0x57(SB)/1, $0x07
DATA h2_downsample_consts<>+0x58(SB)/1, $0x08
DATA h2_downsample_consts<>+0x59(SB)/1, $0x09
DATA h2_downsample_consts<>+0x5a(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x5b(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x5c(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x5d(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x5e(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x5f(SB)/1, $0x0A
DATA h2_downsample_consts<>+0x60(SB)/1, $0x00
DATA h2_downsample_consts<>+0x61(SB)/1, $0x01
DATA h2_downsample_consts<>+0x62(SB)/1, $0x02
DATA h2_downsample_consts<>+0x63(SB)/1, $0x03
DATA h2_downsample_consts<>+0x64(SB)/1, $0x04
DATA h2_downsample_consts<>+0x65(SB)/1, $0x05
DATA h2_downsample_consts<>+0x66(SB)/1, $0x06
DATA h2_downsample_consts<>+0x67(SB)/1, $0x07
DATA h2_downsample_consts<>+0x68(SB)/1, $0x08
DATA h2_downsample_consts<>+0x69(SB)/1, $0x09
DATA h2_downsample_consts<>+0x6a(SB)/1, $0x09
DATA h2_downsample_consts<>+0x6b(SB)/1, $0x09
DATA h2_downsample_consts<>+0x6c(SB)/1, $0x09
DATA h2_downsample_consts<>+0x6d(SB)/1, $0x09
DATA h2_downsample_consts<>+0x6e(SB)/1, $0x09
DATA h2_downsample_consts<>+0x6f(SB)/1, $0x09
DATA h2_downsample_consts<>+0x70(SB)/1, $0x00
DATA h2_downsample_consts<>+0x71(SB)/1, $0x01
DATA h2_downsample_consts<>+0x72(SB)/1, $0x02
DATA h2_downsample_consts<>+0x73(SB)/1, $0x03
DATA h2_downsample_consts<>+0x74(SB)/1, $0x04
DATA h2_downsample_consts<>+0x75(SB)/1, $0x05
DATA h2_downsample_consts<>+0x76(SB)/1, $0x06
DATA h2_downsample_consts<>+0x77(SB)/1, $0x07
DATA h2_downsample_consts<>+0x78(SB)/1, $0x08
DATA h2_downsample_consts<>+0x79(SB)/1, $0x08
DATA h2_downsample_consts<>+0x7a(SB)/1, $0x08
DATA h2_downsample_consts<>+0x7b(SB)/1, $0x08
DATA h2_downsample_consts<>+0x7c(SB)/1, $0x08
DATA h2_downsample_consts<>+0x7d(SB)/1, $0x08
DATA h2_downsample_consts<>+0x7e(SB)/1, $0x08
DATA h2_downsample_consts<>+0x7f(SB)/1, $0x08
DATA h2_downsample_consts<>+0x80(SB)/1, $0x00
DATA h2_downsample_consts<>+0x81(SB)/1, $0x01
DATA h2_downsample_consts<>+0x82(SB)/1, $0x02
DATA h2_downsample_consts<>+0x83(SB)/1, $0x03
DATA h2_downsample_consts<>+0x84(SB)/1, $0x04
DATA h2_downsample_consts<>+0x85(SB)/1, $0x05
DATA h2_downsample_consts<>+0x86(SB)/1, $0x06
DATA h2_downsample_consts<>+0x87(SB)/1, $0x07
DATA h2_downsample_consts<>+0x88(SB)/1, $0x07
DATA h2_downsample_consts<>+0x89(SB)/1, $0x07
DATA h2_downsample_consts<>+0x8a(SB)/1, $0x07
DATA h2_downsample_consts<>+0x8b(SB)/1, $0x07
DATA h2_downsample_consts<>+0x8c(SB)/1, $0x07
DATA h2_downsample_consts<>+0x8d(SB)/1, $0x07
DATA h2_downsample_consts<>+0x8e(SB)/1, $0x07
DATA h2_downsample_consts<>+0x8f(SB)/1, $0x07
DATA h2_downsample_consts<>+0x90(SB)/1, $0x00
DATA h2_downsample_consts<>+0x91(SB)/1, $0x01
DATA h2_downsample_consts<>+0x92(SB)/1, $0x02
DATA h2_downsample_consts<>+0x93(SB)/1, $0x03
DATA h2_downsample_consts<>+0x94(SB)/1, $0x04
DATA h2_downsample_consts<>+0x95(SB)/1, $0x05
DATA h2_downsample_consts<>+0x96(SB)/1, $0x06
DATA h2_downsample_consts<>+0x97(SB)/1, $0x06
DATA h2_downsample_consts<>+0x98(SB)/1, $0x06
DATA h2_downsample_consts<>+0x99(SB)/1, $0x06
DATA h2_downsample_consts<>+0x9a(SB)/1, $0x06
DATA h2_downsample_consts<>+0x9b(SB)/1, $0x06
DATA h2_downsample_consts<>+0x9c(SB)/1, $0x06
DATA h2_downsample_consts<>+0x9d(SB)/1, $0x06
DATA h2_downsample_consts<>+0x9e(SB)/1, $0x06
DATA h2_downsample_consts<>+0x9f(SB)/1, $0x06
DATA h2_downsample_consts<>+0xa0(SB)/1, $0x00
DATA h2_downsample_consts<>+0xa1(SB)/1, $0x01
DATA h2_downsample_consts<>+0xa2(SB)/1, $0x02
DATA h2_downsample_consts<>+0xa3(SB)/1, $0x03
DATA h2_downsample_consts<>+0xa4(SB)/1, $0x04
DATA h2_downsample_consts<>+0xa5(SB)/1, $0x05
DATA h2_downsample_consts<>+0xa6(SB)/1, $0x05
DATA h2_downsample_consts<>+0xa7(SB)/1, $0x05
DATA h2_downsample_consts<>+0xa8(SB)/1, $0x05
DATA h2_downsample_consts<>+0xa9(SB)/1, $0x05
DATA h2_downsample_consts<>+0xaa(SB)/1, $0x05
DATA h2_downsample_consts<>+0xab(SB)/1, $0x05
DATA h2_downsample_consts<>+0xac(SB)/1, $0x05
DATA h2_downsample_consts<>+0xad(SB)/1, $0x05
DATA h2_downsample_consts<>+0xae(SB)/1, $0x05
DATA h2_downsample_consts<>+0xaf(SB)/1, $0x05
DATA h2_downsample_consts<>+0xb0(SB)/1, $0x00
DATA h2_downsample_consts<>+0xb1(SB)/1, $0x01
DATA h2_downsample_consts<>+0xb2(SB)/1, $0x02
DATA h2_downsample_consts<>+0xb3(SB)/1, $0x03
DATA h2_downsample_consts<>+0xb4(SB)/1, $0x04
DATA h2_downsample_consts<>+0xb5(SB)/1, $0x04
DATA h2_downsample_consts<>+0xb6(SB)/1, $0x04
DATA h2_downsample_consts<>+0xb7(SB)/1, $0x04
DATA h2_downsample_consts<>+0xb8(SB)/1, $0x04
DATA h2_downsample_consts<>+0xb9(SB)/1, $0x04
DATA h2_downsample_consts<>+0xba(SB)/1, $0x04
DATA h2_downsample_consts<>+0xbb(SB)/1, $0x04
DATA h2_downsample_consts<>+0xbc(SB)/1, $0x04
DATA h2_downsample_consts<>+0xbd(SB)/1, $0x04
DATA h2_downsample_consts<>+0xbe(SB)/1, $0x04
DATA h2_downsample_consts<>+0xbf(SB)/1, $0x04
DATA h2_downsample_consts<>+0xc0(SB)/1, $0x00
DATA h2_downsample_consts<>+0xc1(SB)/1, $0x01
DATA h2_downsample_consts<>+0xc2(SB)/1, $0x02
DATA h2_downsample_consts<>+0xc3(SB)/1, $0x03
DATA h2_downsample_consts<>+0xc4(SB)/1, $0x03
DATA h2_downsample_consts<>+0xc5(SB)/1, $0x03
DATA h2_downsample_consts<>+0xc6(SB)/1, $0x03
DATA h2_downsample_consts<>+0xc7(SB)/1, $0x03
DATA h2_downsample_consts<>+0xc8(SB)/1, $0x03
DATA h2_downsample_consts<>+0xc9(SB)/1, $0x03
DATA h2_downsample_consts<>+0xca(SB)/1, $0x03
DATA h2_downsample_consts<>+0xcb(SB)/1, $0x03
DATA h2_downsample_consts<>+0xcc(SB)/1, $0x03
DATA h2_downsample_consts<>+0xcd(SB)/1, $0x03
DATA h2_downsample_consts<>+0xce(SB)/1, $0x03
DATA h2_downsample_consts<>+0xcf(SB)/1, $0x03
DATA h2_downsample_consts<>+0xd0(SB)/1, $0x00
DATA h2_downsample_consts<>+0xd1(SB)/1, $0x01
DATA h2_downsample_consts<>+0xd2(SB)/1, $0x02
DATA h2_downsample_consts<>+0xd3(SB)/1, $0x02
DATA h2_downsample_consts<>+0xd4(SB)/1, $0x02
DATA h2_downsample_consts<>+0xd5(SB)/1, $0x02
DATA h2_downsample_consts<>+0xd6(SB)/1, $0x02
DATA h2_downsample_consts<>+0xd7(SB)/1, $0x02
DATA h2_downsample_consts<>+0xd8(SB)/1, $0x02
DATA h2_downsample_consts<>+0xd9(SB)/1, $0x02
DATA h2_downsample_consts<>+0xda(SB)/1, $0x02
DATA h2_downsample_consts<>+0xdb(SB)/1, $0x02
DATA h2_downsample_consts<>+0xdc(SB)/1, $0x02
DATA h2_downsample_consts<>+0xdd(SB)/1, $0x02
DATA h2_downsample_consts<>+0xde(SB)/1, $0x02
DATA h2_downsample_consts<>+0xdf(SB)/1, $0x02
DATA h2_downsample_consts<>+0xe0(SB)/1, $0x00
DATA h2_downsample_consts<>+0xe1(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe2(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe3(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe4(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe5(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe6(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe7(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe8(SB)/1, $0x01
DATA h2_downsample_consts<>+0xe9(SB)/1, $0x01
DATA h2_downsample_consts<>+0xea(SB)/1, $0x01
DATA h2_downsample_consts<>+0xeb(SB)/1, $0x01
DATA h2_downsample_consts<>+0xec(SB)/1, $0x01
DATA h2_downsample_consts<>+0xed(SB)/1, $0x01
DATA h2_downsample_consts<>+0xee(SB)/1, $0x01
DATA h2_downsample_consts<>+0xef(SB)/1, $0x01
DATA h2_downsample_consts<>+0xf0(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf1(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf2(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf3(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf4(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf5(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf6(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf7(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf8(SB)/1, $0x00
DATA h2_downsample_consts<>+0xf9(SB)/1, $0x00
DATA h2_downsample_consts<>+0xfa(SB)/1, $0x00
DATA h2_downsample_consts<>+0xfb(SB)/1, $0x00
DATA h2_downsample_consts<>+0xfc(SB)/1, $0x00
DATA h2_downsample_consts<>+0xfd(SB)/1, $0x00
DATA h2_downsample_consts<>+0xfe(SB)/1, $0x00
DATA h2_downsample_consts<>+0xff(SB)/1, $0x00

GLOBL h2_downsample_consts<>(SB), NOPTR+RODATA, $256

TEXT ·downsampleasm(SB),$0-32
	// move all arguments into registers as per the ARM64 calling convention
	MOVW image_width+0(FP), R0
	MOVW max_v_samp_factor+4(FP), R1
	MOVW v_samp_factor+8(FP), R2
	MOVW width_blocks+12(FP), R3
	MOVD input_data+16(FP), R4
	MOVD output_data+24(FP), R5

	WORD $0x5280002f // mov	w15, #0x1                   	// #1
	WORD $0xd37cec6c // lsl	x12, x3, #4
	WORD $0x530f39ef // lsl	w15, w15, #17
	SUB R0, R12, R12 // sub x12, x12, x0
	MOVD $h2_downsample_consts<>(SB), R13 // adr	x13, 0 <·Ljsimd_h2_downsample_neon_consts>
	WORD $0x320001ef // orr	w15, w15, #0x1
	WORD $0x8b0c11ad // add	x13, x13, x12, lsl #4
	WORD $0x4e040df0 // dup	v16.4s, w15
	WORD $0x4c4071b2 // ld1	{v18.16b}, [x13]

	// row loop
l1:
	WORD $0xf840848a // ldr	x10, [x4], #8
	WORD $0xf84084a9 // ldr	x9, [x5], #8
	WORD $0xf840848e // ldr	x14, [x4], #8
	WORD $0xf100046b // subs	x11, x3, #0x1
	BEQ l3

	// columns
l2:
	WORD $0x4cdf7140 // ld1	{v0.16b}, [x10], #16
	WORD $0x4cdf71c1 // ld1	{v1.16b}, [x14], #16
	WORD $0x4eb01e04 // mov	v4.16b, v16.16b
	WORD $0xf100056b // subs	x11, x11, #0x1
	WORD $0x6e206804 // uadalp	v4.8h, v0.16b
	WORD $0x6e206824 // uadalp	v4.8h, v1.16b
	WORD $0x0f0e8486 // shrn	v6.8b, v4.8h, #2
	WORD $0x0c9f7126 // st1	{v6.8b}, [x9], #8
	BNE l2

	// last columns
l3:
	WORD $0x4cdf7140 // ld1	{v0.16b}, [x10], #16
	WORD $0x4cdf71c1 // ld1	{v1.16b}, [x14], #16
	WORD $0x4eb01e04 // mov	v4.16b, v16.16b
	WORD $0xf1000442 // subs	x2, x2, #0x1
	// expand right
	WORD $0x4e120002 // tbl	v2.16b, {v0.16b}, v18.16b
	WORD $0x4e120023 // tbl	v3.16b, {v1.16b}, v18.16b
	WORD $0x6e206844 // uadalp	v4.8h, v2.16b
	WORD $0x6e206864 // uadalp	v4.8h, v3.16b
	WORD $0x0f0e8486 // shrn	v6.8b, v4.8h, #2
	WORD $0x0c9f7126 // st1	{v6.8b}, [x9], #8
	BNE l1
	RET              // br	x30
